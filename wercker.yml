box: debian

services:
  - id: mongo
    name: mongo

build:

  steps:
    - script:
        name: Install basic packages
        code: |
            apt-get update && \
            apt-get install git -y && \
            apt-get install -y git curl bzip2 gnupg libcap2-bin && \
            (curl https://deb.nodesource.com/setup_4.x | bash) && \
            apt-get install -y jq && \

            curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add - && \
            echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list && \
            sudo apt-get update && sudo apt-get install -y yarn && \
            apt-get clean && \

            rm -Rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

    # - add-ssh-key:
    #     keyname: KEY_NAME
    #     host: github.com
    # - add-to-known_hosts:
    #     hostname: github.com
    #     fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
    - script:
        name: initialize git submodules
        code: |
            git submodule update --init --recursive

    - script:
        name: Install meteor
        code: |
          curl https://install.meteor.com | /bin/sh && \
          groupadd -g 99999 -r meteor && \
          useradd -u 99999 -r -g meteor meteor 

    - script:
        name: Build App
        code: |

          export MONGO_URL=mongodb://mongo:27017/talk && \
          export ROOT_URL=http://localhost:3000 && \
          export PORT=3000 && \
          export DEPLOY_METHOD=docker && \
          export METEOR_ALLOW_SUPERUSER=1 && \
          yarn
          meteor build --server-only /home/meteor/build && \
          ls -l /home/meteor/build
